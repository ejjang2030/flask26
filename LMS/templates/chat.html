{% extends "layout.html" %}

{% block title %}ëœë¤ ì±„íŒ…{% endblock %}

{% block content %}
<style>
    /* ë©”ì¸ í¬ì¸íŠ¸ ì»¬ëŸ¬ ì„¤ì •: #269CA6 */
    :root {
        --main-color: #269CA6;
        --main-hover: #1f7d85;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë§¤ì¹­ ì‹œì‘, ì „ì†¡) */
    .btn-main {
        background-color: var(--main-color) !important;
        border: none !important;
        color: white !important;
        transition: background-color 0.2s;
    }
    .btn-main:hover {
        background-color: var(--main-hover) !important;
    }

    /* ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œ í…Œë‘ë¦¬ ë° ê¸€ë¡œìš° íš¨ê³¼ ê°•ì œ ë³€ê²½ */
    .form-control:focus {
        border-color: var(--main-color) !important;
        outline: 0 !important;
        /* íŒŒë€ìƒ‰ ëŒ€ì‹  #269CA6ì˜ ë°˜íˆ¬ëª…(0.25) ë²„ì „ ì ìš© */
        box-shadow: 0 0 0 0.25rem rgba(38, 156, 166, 0.25) !important;
    }

    /* ë‚´ ë§í’ì„  í¬ì¸íŠ¸ ì»¬ëŸ¬ ì ìš© */
    .my-bubble {
        background-color: var(--main-color) !important;
        color: white !important;
    }
</style>

<div class="container py-5">
    <div class="mb-4">
        <h2 class="fw-bold">ğŸ’¬ ëœë¤ ì±„íŒ…</h2>
        <p class="text-muted small">ìƒˆë¡œìš´ ì‚¬ìš©ìì™€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë§¤ì¹­ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-header bg-white fw-bold border-bottom-0 pt-3">ì±„íŒ…ì°½</div>
                <div class="card-body" id="chat-box" style="height:450px; overflow-y:auto; background:#f8f9fa;">
                </div>
                <div class="card-footer bg-white border-top-0 pb-3">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control rounded-start-pill ps-3" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                        <button class="btn btn-main rounded-end-pill px-4" id="send-btn">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-body text-center py-4">
                    <h6 class="fw-bold mb-3">ëœë¤ ë§¤ì¹­</h6>
                    <button class="btn btn-main w-100 mb-2 py-2 fw-bold" id="match-btn">ë§¤ì¹­ ì‹œì‘</button>
                    <button class="btn btn-outline-danger w-100 py-2 fw-bold" id="leave-btn">ì±„íŒ… ì¢…ë£Œ</button>
                    <hr class="my-4">
                    <p class="small text-muted mb-0">ìƒíƒœ: <span id="status-text" class="fw-bold text-secondary">ëŒ€ê¸°ì¤‘</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    const chatBox = document.getElementById("chat-box");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const matchBtn = document.getElementById("match-btn");
    const leaveBtn = document.getElementById("leave-btn");
    const statusText = document.getElementById("status-text");

    let currentRoom = null;

    matchBtn.addEventListener("click", function () {
        if (currentRoom) return;
        matchBtn.disabled = true;
        socket.emit("random_match");
        statusText.innerText = "ë§¤ì¹­ ì¤‘...";
        statusText.className = "fw-bold text-warning";
    });

    socket.on("matched", function (data) {
        currentRoom = data.room;
        statusText.innerText = "ì±„íŒ… ì¤‘";
        statusText.className = "fw-bold text-success";
        addMessage("ğŸ“¢ ì‹œìŠ¤í…œ", `${data.partner_name}ë‹˜ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    });

    socket.on("receive_message", function (data) {
        addMessage(data.user, data.message);
        if (data.user === "ğŸ“¢ ì‹œìŠ¤í…œ" && data.message.includes("ë‚˜ê°”ìŠµë‹ˆë‹¤")) {
            resetChatState();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !currentRoom) return;
        socket.emit("send_message", { room: currentRoom, message: message });
        addMessage("ë‚˜", message);
        messageInput.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });

    leaveBtn.addEventListener("click", function () {
        if (currentRoom) {
            socket.emit("leave_room", { room: currentRoom });
            addMessage("ğŸ“¢ ì‹œìŠ¤í…œ", "ì±„íŒ…ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.");
            resetChatState();
        }
    });

    function resetChatState() {
        currentRoom = null;
        statusText.innerText = "ëŒ€ê¸°ì¤‘";
        statusText.className = "fw-bold text-secondary";
        matchBtn.disabled = false;
    }

    function addMessage(user, message) {
        const div = document.createElement("div");
        div.className = "d-flex flex-column mb-3";

        let alignClass = "align-items-start";
        let extraClass = "bg-white text-dark border";

        if (user === "ë‚˜") {
            alignClass = "align-items-end";
            extraClass = "my-bubble border-0 shadow-sm";
        } else if (user === "ğŸ“¢ ì‹œìŠ¤í…œ") {
            alignClass = "align-items-center w-100";
            extraClass = "bg-transparent text-muted small border-0 text-center";
        }

        div.innerHTML = `
            <div class="${alignClass} w-100 d-flex flex-column ${user === 'ë‚˜' ? 'align-items-end' : (user === 'ğŸ“¢ ì‹œìŠ¤í…œ' ? 'align-items-center' : 'align-items-start')}">
                ${user !== "ë‚˜" && user !== "ğŸ“¢ ì‹œìŠ¤í…œ" ? `<small class="fw-bold mb-1 ms-2">${user}</small>` : ''}
                <div class="p-2 px-3 rounded-4 ${extraClass}" style="max-width: 75%; word-break: break-all;">
                    ${message}
                </div>
            </div>
        `;

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
{% endblock %}