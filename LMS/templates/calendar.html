{% extends 'layout.html' %}

{% block content %}
<style>
    /* Communa ë¸Œëœë“œ ì»¬ëŸ¬ ì •ì˜ */
    :root {
        --communa-primary: #20828A;
        --communa-hover: #186b72;
        --communa-light: rgba(32, 130, 138, 0.1);
        --communa-bg: #f8f9fa;
    }

    /* 1. ìº˜ë¦°ë” ì»¨í…Œì´ë„ˆ ì¹´ë“œ */
    .calendar-card {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        background-color: white;
        overflow: hidden;
    }

    /* 2. FullCalendar ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ë§ (ê¸°ë³¸ íŒŒë€ìƒ‰ ë®ì–´ì“°ê¸°) */

    /* ìƒë‹¨ íˆ´ë°” ë²„íŠ¼ (ì˜¤ëŠ˜, ì›”, ì£¼, ì¼ ë“±) */
    .fc .fc-button-primary {
        background-color: white;
        border-color: #e0e0e0;
        color: #555;
        font-weight: bold;
        transition: all 0.2s;
    }
    .fc .fc-button-primary:hover {
        background-color: var(--communa-light);
        border-color: var(--communa-primary);
        color: var(--communa-primary);
    }
    .fc .fc-button-primary:not(:disabled).fc-button-active,
    .fc .fc-button-primary:not(:disabled):active {
        background-color: var(--communa-primary);
        border-color: var(--communa-primary);
        color: white;
    }

    /* ìš”ì¼ í—¤ë” */
    .fc-col-header-cell {
        background-color: #fcfcfc;
        padding: 15px 0 !important;
        color: #555;
        font-weight: 600;
        border-bottom: 2px solid #f0f0f0 !important;
    }
    .fc-col-header-cell-cushion {
        text-decoration: none;
        color: #333;
    }

    /* ì˜¤ëŠ˜ ë‚ ì§œ í•˜ì´ë¼ì´íŠ¸ */
    .fc-day-today {
        background-color: var(--communa-light) !important;
    }

    /* ë‚ ì§œ ì…€ í˜¸ë²„ íš¨ê³¼ */
    .fc-daygrid-day:hover {
        background-color: #f9f9f9;
        cursor: pointer;
    }

    /* ì¼ì •(Event) ë§‰ëŒ€ ë””ìì¸ */
    .fc-event {
        cursor: pointer;
        padding: 3px 6px;
        border-radius: 6px;
        border: none;
        background-color: var(--communa-primary); /* ê¸°ë³¸ ë°°ê²½ */
        border-left: 4px solid var(--communa-hover); /* ì™¼ìª½ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        font-size: 0.85rem;
        margin-bottom: 2px;
    }
    .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }

    /* ì¼ì • ì œëª© í…ìŠ¤íŠ¸ */
    .fc-event-title {
        font-weight: 500;
        color: white;
    }

    /* 3. ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .modal-header {
        border-bottom: 1px solid #f0f0f0;
        padding: 1.5rem;
    }
    .modal-footer {
        border-top: none;
        padding: 1.5rem;
    }
</style>

<div class="container mt-4 mb-5" style="max-width: 1200px;">
    <div class="card calendar-card">
        <div class="card-body p-4 p-md-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0" style="color: #333;">
                    <i class="bi bi-calendar-check me-2" style="color: #20828A;"></i> ë‚´ ì¼ì • ê´€ë¦¬
                </h4>
                <span class="badge bg-light text-secondary border rounded-pill px-3 py-2">
                    <i class="bi bi-info-circle me-1"></i> ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ì¼ì • ì¶”ê°€
                </span>
            </div>

            <div id='calendar'></div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">
                    <i class="bi bi-bookmark-star-fill text-warning me-2"></i>ì¼ì • ìƒì„¸
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4">
                <label class="small text-muted fw-bold mb-2">ìƒì„¸ ë‚´ìš©</label>
                <div id="modalDescription" class="p-3 bg-light rounded-3 text-secondary"
                     style="min-height: 100px; white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger rounded-pill px-4" id="btnDeleteEvent">
                    <i class="bi bi-trash3 me-1"></i> ì‚­ì œ
                </button>
                <button type="button" class="btn text-white rounded-pill px-4" data-bs-dismiss="modal"
                        style="background-color: #20828A;">í™•ì¸</button>
            </div>
        </div>
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var eventModalElement = document.getElementById('eventModal');
    var eventModal = new bootstrap.Modal(eventModalElement);

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ko', // í•œêµ­ì–´ ì„¤ì •
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listWeek'
      },
      height: 'auto',       // ë†’ì´ ìë™ ì¡°ì ˆ
      aspectRatio: 1.8,     // ë¹„ìœ¨ ì¡°ì ˆ
      editable: true,       // ë“œë˜ê·¸ ìˆ˜ì • ê°€ëŠ¥ ì—¬ë¶€
      selectable: true,     // ë‚ ì§œ ì„ íƒ ê°€ëŠ¥ ì—¬ë¶€
      displayEventTime: false,
      dayMaxEvents: true,   // ì´ë²¤íŠ¸ê°€ ë§ìœ¼ë©´ '+2 more' ì²˜ëŸ¼ í‘œì‹œ

      // 1. ì¼ì • ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      events: '/calendar/events',

      // 2. ë‚ ì§œ í´ë¦­ (ì¼ì • ì¶”ê°€)
      dateClick: function(info) {
        // ë””ìì¸ í†µì¼ì„±ì„ ìœ„í•´ prompt ëŒ€ì‹  ëª¨ë‹¬ì„ ì“°ë©´ ì¢‹ê² ì§€ë§Œ, ë¡œì§ ìœ ì§€ë¥¼ ìœ„í•´ prompt ì‚¬ìš©
        var title = prompt('ğŸ“… ìƒˆë¡œìš´ ì¼ì •ì˜ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:');

        if (title && title.trim() !== "") {
          var desc = prompt('ğŸ“ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­):');

          fetch('/calendar/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title: title,
              description: desc,
              start: info.dateStr + " 00:00:00",
              end: info.dateStr + " 23:59:59"
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
                calendar.refetchEvents(); // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          });
        }
      },

      // 3. ì¼ì • í´ë¦­ (ìƒì„¸ ë³´ê¸° & ì‚­ì œ)
      eventClick: function(info) {
        // ëª¨ë‹¬ ë°ì´í„° ë°”ì¸ë”©
        document.getElementById('modalTitle').innerText = info.event.title;

        const desc = info.event.extendedProps.description;
        document.getElementById('modalDescription').innerText = desc ? desc : "ì‘ì„±ëœ ìƒì„¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
        var deleteBtn = document.getElementById('btnDeleteEvent');
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ cloneNode ì‚¬ìš© ë˜ëŠ” onclick ì¬í• ë‹¹
        deleteBtn.onclick = function() {
          if (confirm("ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch('/calendar/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: info.event.id })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                eventModal.hide();
                info.event.remove();
              } else {
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            });
          }
        };

        eventModal.show();
      }
    });

    calendar.render();
  });
</script>
{% endblock %}