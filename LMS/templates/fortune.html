{% extends 'layout.html' %}
{% block content %}
<style>
    /* Communa ìŠ¤íƒ€ì¼ ì ìš© */
    .fortune-card { border-radius: 20px; border: none; }
    .btn-fortune { background-color: #20828A; color: white; border: none; border-radius: 50px; font-weight: bold; }
    .btn-fortune:hover { background-color: #186b72; color: white; transform: translateY(-2px); transition: all 0.2s; }

    /* ê²°ê³¼ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .table th { background-color: rgba(32, 130, 138, 0.05); color: #20828A; vertical-align: middle; }
    .result-box { animation: fadeInUp 0.5s ease-out; }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="container mt-5" style="max-width: 800px;">
    <h2 class="text-center mb-4 fw-bold" style="color: #20828A;">ğŸ’« ì˜¤ëŠ˜ì˜ ë ë³„ ìš´ì„¸ ğŸ’«</h2>

    <div class="card shadow-lg mb-5 fortune-card">
        <div class="card-body bg-white p-5">
            <form method="GET" action="/fortune" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">ì¶œìƒ ì—°ë„</label>
                    <input type="number" name="year" class="form-control form-control-lg bg-light border-0"
                           placeholder="YYYY" min="1900" max="2026" required
                           value="{{ request.args.get('year', '') }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">ì›”</label>
                    <input type="number" name="month" class="form-control form-control-lg bg-light border-0"
                           placeholder="MM" min="1" max="12" required
                           value="{{ request.args.get('month', '') }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">ì¼</label>
                    <input type="number" name="day" class="form-control form-control-lg bg-light border-0"
                           placeholder="DD" min="1" max="31" required
                           value="{{ request.args.get('day', '') }}">
                </div>
                <div class="col-12 text-center mt-4">
                    <button type="submit" class="btn btn-fortune px-5 py-3 shadow-sm">
                        <i class="bi bi-stars me-2"></i>ë‚´ ìš´ì„¸ í™•ì¸í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if data %}
    <div id="fortuneResult" class="result-box">
        <div class="card shadow border-0 fortune-card overflow-hidden">
            <div class="card-header text-white text-center py-3" style="background-color: #20828A;">
                <h4 class="mb-0">âœ¨ {{ data.zodiac }} ìš´ì„¸ ê²°ê³¼</h4>
            </div>
            <div class="card-body p-0">
                <table class="table table-bordered mb-0 align-middle">
                    <tbody>
                        <tr class="text-center">
                            <th style="width: 25%;">ì •ë³´</th>
                            <td class="text-start ps-4">{{ data.birth }} (ë§Œ {{ data.age }}ì„¸)</td>
                        </tr>
                        <tr>
                            <th class="text-center text-primary"><i class="bi bi-sun-fill me-2"></i>ì˜¤ëŠ˜</th>
                            <td class="p-4 lh-lg">{{ data.today }}</td>
                        </tr>
                        <tr>
                            <th class="text-center text-secondary"><i class="bi bi-moon-stars-fill me-2"></i>ë‚´ì¼</th>
                            <td class="p-4 lh-lg">{{ data.tomorrow }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="d-grid gap-2 col-md-8 mx-auto mt-4 mb-5">
            <button onclick="shareResult()" class="btn btn-dark rounded-pill fw-bold py-3 shadow-sm">
                <i class="bi bi-share-fill me-2"></i>
                <span id="shareBtnText">ìš´ì„¸ ê²°ê³¼ ê³µìœ í•˜ê¸°</span>
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // 1. ê³µìœ í•  ë°ì´í„° ì¤€ë¹„ (í˜„ì¬ í˜ì´ì§€ URLì— ì´ë¯¸ ?year=... ì •ë³´ê°€ ë“¤ì–´ìˆìŒ)
    const shareUrl = window.location.href;

    // í…œí”Œë¦¿ ë¬¸ë²•ì´ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¬¸ìì—´ ì•ˆì—ì„œ ê¹¨ì§€ì§€ ì•Šë„ë¡ ì²˜ë¦¬
    {% if data %}
    const shareTitle = "ğŸ’« [ìš´ì„¸ ë„ì°©] {{ data.zodiac }} ì˜¤ëŠ˜ì˜ ìš´ì„¸";
    const shareText = "ì˜¤ëŠ˜ì˜ ìš´ì„¸: {{ data.today | truncate(30) }}... \nìì„¸í•œ ë‚´ìš©ì€ ë§í¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”!";
    {% else %}
    const shareTitle = "Communa ë¬´ë£Œ ìš´ì„¸";
    const shareText = "ì˜¤ëŠ˜ì˜ ë ë³„ ìš´ì„¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.";
    {% endif %}

    // 2. í†µí•© ê³µìœ  í•¨ìˆ˜ (ëª¨ë°”ì¼: ê³µìœ ì‹œíŠ¸ / PC: í´ë¦½ë³´ë“œ)
    async function shareResult() {
        // (A) ëª¨ë°”ì¼ ë“± ê³µìœ  ê¸°ëŠ¥ì´ ìˆëŠ” ë¸Œë¼ìš°ì €
        if (navigator.share) {
            try {
                await navigator.share({
                    title: shareTitle,
                    text: shareText,
                    url: shareUrl,
                });
            } catch (err) {
                console.log('ê³µìœ  ì·¨ì†Œë¨');
            }
        }
        // (B) PC ë“± ê³µìœ  ê¸°ëŠ¥ì´ ì—†ëŠ” ë¸Œë¼ìš°ì € -> í´ë¦½ë³´ë“œ ë³µì‚¬
        else {
            try {
                await navigator.clipboard.writeText(shareUrl);
                alert('ìš´ì„¸ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! \nì¹´í†¡ì´ë‚˜ SNSì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
            } catch (err) {
                prompt('ì´ ì£¼ì†Œë¥¼ ë³µì‚¬í•´ì„œ ê³µìœ í•˜ì„¸ìš”:', shareUrl);
            }
        }
    }

    // PC ì ‘ì† ì‹œ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ (UX ê°œì„ )
    document.addEventListener("DOMContentLoaded", function() {
        if (!navigator.share) {
            document.getElementById('shareBtnText').innerText = "ìš´ì„¸ ë§í¬ ë³µì‚¬í•˜ê¸°";
        }
    });
</script>
{% endblock %}