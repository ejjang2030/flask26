{% extends 'layout.html' %}

{% block content %}
<style>
    :root {
        --communa-teal: #20828A;
        --communa-light-teal: rgba(32, 130, 138, 0.08);
    }

    .view-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.04);
        border: 1px solid #f1f3f5;
        overflow: hidden;
    }

    .view-header {
        background-color: #fcfdfe;
        padding: 40px 40px 20px 40px;
        border-bottom: 1px solid #f1f3f5;
    }

    .view-content {
        padding: 40px;
        line-height: 1.8;
        font-size: 1.05rem;
        color: #343a40;
        min-height: 250px;
    }

    /* --- [수정] 좋아요/싫어요 버튼 스타일 --- */
    .reaction-btn {
        transition: all 0.3s ease;
        border-radius: 50px;
        padding: 12px 30px;
        font-size: 1.1rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    /* 좋아요 버튼 */
    #like-btn {
        border: 2px solid #ffeded;
        background: #fff5f5;
        color: #ff4d4d;
    }
    #like-btn:hover { background-color: #ffe0e0; }

    #like-btn.active {
        background: #ff4d4d;
        color: white;
        border-color: #ff4d4d;
        box-shadow: 0 5px 15px rgba(255, 77, 77, 0.3);
    }

    /* 싫어요 버튼 */
    #dislike-btn {
        border: 2px solid #e9ecef;
        background: #f8f9fa;
        color: #495057;
    }
    #dislike-btn:hover { background-color: #e2e6ea; }

    #dislike-btn.active {
        background: #495057; /* 짙은 회색 */
        color: white;
        border-color: #495057;
        box-shadow: 0 5px 15px rgba(73, 80, 87, 0.3);
    }
    /* ------------------------------------- */

    /* 댓글 섹션 */
    .comment-card {
        background-color: #fcfdfe;
        border-radius: 15px;
        border: 1px solid #f1f3f5;
    }
    .comment-input:focus {
        border-color: var(--communa-teal);
        box-shadow: 0 0 0 0.25rem var(--communa-light-teal);
    }

    /* 버튼 스타일 */
    .btn-communa {
        background-color: var(--communa-teal);
        color: white;
        border: none;
    }
    .btn-communa:hover {
        background-color: #1a6d74;
        color: white;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="view-container">
            <div class="view-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge px-3 py-2" style="background-color: var(--communa-light-teal); color: var(--communa-teal);">자유게시판</span>
                    </div>
                </div>
                <div>
                    <h2 class="fw-bold mt-2" style="letter-spacing: -1px; line-height: 1.4;">{{ board.title }}</h2>
                </div>

                <div class="d-flex justify-content-between align-items-center p-3 rounded-3" style="background-color: #f8f9fa;">
                    <div class="d-flex align-items-center">
                        <div class="bg-white shadow-sm rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px; border: 1px solid #eee;">
                            <i class="bi bi-person-fill text-secondary fs-5"></i>
                        </div>
                        <div>
                            <div class="fw-bold text-dark">{{ board.writer_name }}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">{{ board.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
                        </div>
                    </div>
                    <div class="d-flex gap-3">
                        <div class="text-center">
                            <div class="text-muted small">조회수</div>
                            <div class="fw-bold"><i class="bi bi-eye me-1"></i>{{ board.visits }}</div>
                        </div>
                        <div class="vr"></div>
                        <div class="text-center">
                            <div class="text-muted small">좋아요</div>
                            <div class="fw-bold text-danger"><i class="bi bi-heart-fill me-1"></i>{{ board.likes }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="view-content">
                {{ board.content | safe }}
            </div>

            <div class="d-flex justify-content-center gap-3 mb-4">

                <button id="like-btn" class="btn btn-lg fw-bold reaction-btn {% if user_liked %}active{% endif %}"
                        onclick="toggleLike({{ board.id }})">
                    <i class="bi {% if user_liked %}bi-heart-fill{% else %}bi-heart{% endif %}" id="like-icon"></i>
                    <span>좋아요</span>
                    <span id="like-count" class="ms-1">{{ board.likes }}</span>
                </button>

                <button id="dislike-btn" class="btn btn-lg fw-bold reaction-btn {% if user_disliked %}active{% endif %}"
                        onclick="toggleDislike({{ board.id }})">
                    <i class="bi {% if user_disliked %}bi-hand-thumbs-down-fill{% else %}bi-hand-thumbs-down{% endif %}" id="dislike-icon"></i>
                    <span>싫어요</span>
                    <span id="dislike-count" class="ms-1">{{ board.dislikes }}</span>
                </button>

            </div>

            <div class="d-flex justify-content-center gap-2 mb-5">
                <a href="/board" class="btn btn-sm btn-outline-secondary rounded-pill px-3 text-white" style="background-color: var(--communa-teal);">목록으로 돌아가기</a>
                {% if session.get('user_id') == board.member_id %}
                <a href="/board/edit/{{ board.id }}" class="btn btn-sm btn-outline-secondary rounded-pill px-3">수정</a>
                <a href="/board/delete/{{ board.id }}" class="btn btn-sm btn-outline-danger rounded-pill px-3 ms-1" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</a>
                {% endif %}
            </div>

            <div class="bg-light p-4 p-md-5">
                <h5 class="fw-bold mb-4">
                    <i class="bi bi-chat-left-text me-2"></i>댓글
                    <span style="color: var(--communa-teal);">{{ comments|length }}</span>
                </h5>

                <div class="card border-0 shadow-sm mb-5 rounded-4">
                    <div class="card-body p-3">
                        <div class="d-flex">
                            <textarea id="comment-content" class="form-control border-0 comment-input" rows="2" placeholder="따뜻한 댓글을 남겨주세요." style="resize: none;"></textarea>
                            <button class="btn btn-communa px-4 ms-2 rounded-3 fw-bold" onclick="submitComment(null)">등록</button>
                        </div>
                    </div>
                </div>

                {% macro render_comment(comment_list) %}
                    {% for c in comment_list %}
                    <div class="mb-4 {% if c.parent_id %}ms-5 ps-3 border-start border-2{% endif %}" id="comment-{{ c.id }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="fw-bold text-dark me-2">{{ c.writer_name }}</span>
                                <small class="text-muted">{{ c.created_at }}</small>
                            </div>
                            <button class="btn btn-sm btn-link text-decoration-none p-0 text-muted small" onclick="toggleReplyForm({{ c.id }})">답글</button>
                        </div>
                        <p class="mb-2 text-secondary">{{ c.content }}</p>

                        <div id="reply-form-{{ c.id }}" class="mt-3 d-none">
                            <div class="input-group input-group-sm bg-white p-2 rounded-3 shadow-sm">
                                <input type="text" id="reply-input-{{ c.id }}" class="form-control border-0" placeholder="답글을 입력하세요">
                                <button class="btn btn-communa rounded-2 px-3" onclick="submitComment({{ c.id }})">등록</button>
                            </div>
                        </div>

                        {% if c.children %}
                            <div class="children-list mt-3">
                                {{ render_comment(c.children) }}
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% endmacro %}

                <div id="comment-list">
                    {{ render_comment(comments) }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 좋아요 기능
    function toggleLike(boardId) {
        fetch(`/board/like/${boardId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const btn = document.getElementById('like-btn');
                const icon = document.getElementById('like-icon');
                const count = document.getElementById('like-count');

                count.innerText = data.like_count;

                if (data.is_liked) {
                    btn.classList.add('active');
                    icon.className = 'bi bi-heart-fill';
                } else {
                    btn.classList.remove('active');
                    icon.className = 'bi bi-heart';
                }
            } else {
                alert(data.message);
                if (data.message.includes("로그인")) location.href = "/login";
            }
        });
    }

    // 싫어요 기능
    function toggleDislike(boardId) {
        fetch(`/board/dislike/${boardId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const btn = document.getElementById('dislike-btn');
                const icon = document.getElementById('dislike-icon');
                const count = document.getElementById('dislike-count');

                count.innerText = data.dislike_count;

                if (data.is_disliked) {
                    btn.classList.add('active');
                    icon.className = 'bi bi-hand-thumbs-down-fill';
                } else {
                    btn.classList.remove('active');
                    icon.className = 'bi bi-hand-thumbs-down';
                }
            } else {
                alert(data.message);
                if (data.message.includes("로그인")) location.href = "/login";
            }
        })
        .catch(err => console.error("Error:", err));
    }

    // 답글창 토글
    function toggleReplyForm(commentId) {
        const target = document.getElementById(`reply-form-${commentId}`);
        target.classList.toggle('d-none');
    }

    // 댓글 등록
    function submitComment(parentId) {
        const content = parentId
            ? document.getElementById(`reply-input-${parentId}`).value
            : document.getElementById('comment-content').value;

        if (!content.trim()) {
            alert("내용을 입력해주세요.");
            return;
        }

        fetch(`/board/comment/{{ board.id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content, parent_id: parentId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) { location.reload(); }
            else { alert(data.message); if (data.message.includes("로그인")) location.href = "/login"; }
        });
    }
</script>
{% endblock %}