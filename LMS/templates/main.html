{% extends "layout.html" %}

{% block title %}Communa - 메인{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row g-4">

        <div class="col-lg-8">

            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden" style="background-color: #fff;">
                <div class="card-body p-5 border-start border-5" style="border-color: #20828A !important;">
                    <span class="badge mb-3 px-3 py-2 fw-normal" style="background-color: rgba(32, 130, 138, 0.1); color: #20828A;">
                        <i class="bi bi-stars me-1"></i> Integrated Platform
                    </span>
                    <h1 class="display-6 fw-bold mb-3 text-dark">Communa 플랫폼</h1>
                    <p class="lead text-secondary mb-4 fs-6">
                        업무 효율을 높이는 도구와 재미있는 놀이터가<br>모두 준비되어 있습니다.
                    </p>
                    <div class="d-flex flex-wrap gap-2">
                        {% if session.get('user_id') %}
                            <a href="/board" class="btn btn-primary px-4 border-0 shadow-sm" style="background-color: #269CA6;">
                                <i class="bi bi-pencil-square me-1"></i> 게시판
                            </a>
                            <a href="/chat" class="btn btn-outline-secondary px-4 shadow-sm">
                                <i class="bi bi-chat-dots me-1"></i> 랜덤 채팅
                            </a>
                        {% else %}
                            <a href="/login" class="btn btn-primary px-4 border-0 shadow-sm" style="background-color: #269CA6;">로그인</a>
                            <a href="/join" class="btn btn-outline-secondary px-4 shadow-sm">회원가입</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100 rounded-4 feature-card">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="icon-box me-3 text-success">
                                    <i class="bi bi-people-fill fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">커뮤니티</h5>
                            </div>
                            <p class="text-muted small mb-3">지식을 공유하고 자료를 나누세요.</p>
                            <div class="d-flex gap-2">
                                <a href="/board" class="btn btn-outline-success btn-sm rounded-pill flex-fill">자유게시판</a>
                                <a href="/filesboard" class="btn btn-outline-success btn-sm rounded-pill flex-fill">자료실</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100 rounded-4 feature-card">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="icon-box me-3 text-warning">
                                    <i class="bi bi-controller fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">놀이터</h5>
                            </div>
                            <p class="text-muted small mb-3">다양한 즐길거리가 있습니다.</p>
                            <div class="d-flex gap-2">
                                <a href="/mbti" class="btn btn-outline-warning text-dark btn-sm rounded-pill flex-fill">MBTI</a>
                                <a href="/fortune" class="btn btn-outline-warning text-dark btn-sm rounded-pill flex-fill">운세</a>
                                <a href="/chat" class="btn btn-outline-warning text-dark btn-sm rounded-pill flex-fill">채팅</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-4 rounded-4 shadow-sm border-0 bg-white">
                <h6 class="fw-bold text-dark mb-2"><i class="bi bi-megaphone-fill me-2 text-danger"></i>공지사항</h6>
                <ul class="mb-0 small text-muted lh-lg list-unstyled">
                    <li>- 쾌적한 커뮤니티 환경을 위해 예절을 지켜주세요.</li>
                    <li>- 새로운 기능(운세, MBTI)이 추가되었습니다.</li>
                </ul>
            </div>
        </div>

        <div class="col-lg-4">

            {% if session.get('user_id') %}
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white border-0 pt-4 pb-0 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-primary">
                        <i class="bi bi-calendar-check me-2"></i>다가오는 일정
                    </h6>
                    <a href="/calendar" class="text-decoration-none small text-muted">전체보기 <i class="bi bi-chevron-right"></i></a>
                </div>
                <div class="card-body p-3">
                    <div id="miniCalendar" style="min-height: 250px;"></div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4" style="background-color: #fdfdfd;">
                <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-info">
                        <i class="bi bi-sticky-fill me-2"></i>간편 메모
                    </h6>
                    <a href="/memo" class="text-decoration-none small text-muted">메모장 이동 <i class="bi bi-chevron-right"></i></a>
                </div>
                <div class="card-body p-4">
                    <div class="form-floating mb-2">
                        <textarea class="form-control border-0 shadow-sm" placeholder="Leave a comment here" id="quickMemoContent" style="height: 100px; resize: none; background-color: #fff;"></textarea>
                        <label for="quickMemoContent" class="text-muted small">기억할 내용을 적어두세요</label>
                    </div>
                    <div class="d-grid">
                        <button onclick="saveQuickMemo()" class="btn btn-info text-white rounded-pill btn-sm fw-bold">
                            <i class="bi bi-plus-lg"></i> 메모 저장하기
                        </button>
                    </div>
                </div>
            </div>

            {% else %}
            <div class="card border-0 shadow-sm rounded-4 bg-light text-center py-5">
                <div class="card-body">
                    <i class="bi bi-lock-fill fs-1 text-muted mb-3 d-block"></i>
                    <h5 class="fw-bold text-secondary">로그인 필요</h5>
                    <p class="small text-muted mb-4">
                        일정과 메모 기능을 사용하려면<br>로그인해주세요.
                    </p>
                    <a href="/login" class="btn btn-primary rounded-pill px-4 shadow-sm" style="background-color: #20828A; border: none;">로그인 하러가기</a>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<style>
    .feature-card { transition: transform 0.3s ease; }
    .feature-card:hover { transform: translateY(-5px); }

    .icon-box {
        width: 50px; height: 50px;
        border-radius: 15px;
        background-color: #f8f9fa;
        display: flex; align-items: center; justify-content: center;
    }

    /* 미니 캘린더 스타일 오버라이딩 */
    #miniCalendar .fc-toolbar-title { font-size: 1rem !important; font-weight: bold; }
    #miniCalendar .fc-button { padding: 2px 5px !important; font-size: 0.8rem !important; }
    #miniCalendar .fc-list-event-dot { border-color: #20828A !important; }
    #miniCalendar a { text-decoration: none; color: #333; }
</style>

{% if session.get('user_id') %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('miniCalendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'listWeek', // 리스트 형태로 보기
            locale: 'ko',
            height: 'auto',
            headerToolbar: {
                left: '',
                center: 'title', // '2026년 2월' 형태
                right: '' // 버튼 숨김 (심플하게)
            },
            events: '/calendar/events', // 기존 API 재사용
            noEventsContent: '예정된 일정이 없습니다.',
            eventClick: function(info) {
                // 클릭 시 캘린더 페이지로 이동
                location.href = '/calendar';
            }
        });
        calendar.render();
    });

    // 간편 메모 저장 함수
    function saveQuickMemo() {
        const content = document.getElementById('quickMemoContent').value;
        if (!content.trim()) { alert("내용을 입력해주세요."); return; }

        // 제목은 '간편 메모', 내용은 입력값으로 저장
        fetch('/memo/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: '', title: '메인화면 간편 메모', content: content })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert("메모가 저장되었습니다!");
                document.getElementById('quickMemoContent').value = ''; // 초기화
            } else {
                alert("저장 실패");
            }
        });
    }
</script>
{% endif %}
{% endblock %}