{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <div class="row shadow-sm rounded border overflow-hidden" style="height: 80vh; background-color: #fff;">

                <div class="col-md-3 border-end p-0 bg-light">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                        <h6 class="fw-bold mb-0"><i class="bi bi-sticky-fill text-info"></i> ë‚´ ë©”ëª¨</h6>
                        <button class="btn btn-sm btn-info text-white rounded-pill px-3" onclick="initNewMemo()">
                            <i class="bi bi-plus-lg"></i> ì‹ ê·œ
                        </button>
                    </div>

                    <div class="list-group list-group-flush overflow-auto" id="memo-list" style="max-height: calc(80vh - 60px);">
                        {% for m in memos %}
                        <button class="list-group-item list-group-item-action py-3 border-bottom"
                                onclick="loadMemo({{ m.id }}, `{{ m.title }}`, `{{ m.content }}`)">

                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="fw-bold text-truncate" style="max-width: 80%;">
                                    {% if m.is_pinned %}<span class="text-danger">ğŸ“Œ</span>{% endif %}
                                    {{ m.title }}
                                </div>

                                <span class="pin-btn" onclick="togglePin(event, {{ m.id }})" style="cursor: pointer; padding: 0 5px;">
                                    {% if m.is_pinned %}
                                        <i class="bi bi-pin-angle-fill text-danger" title="ê³ ì • í•´ì œ"></i>
                                    {% else %}
                                        <i class="bi bi-pin-angle text-muted" title="ìƒë‹¨ ê³ ì •"></i>
                                    {% endif %}
                                </span>
                            </div>

                            <div class="small text-muted d-flex justify-content-between">
                                <span>#{{ loop.index }}</span>
                                <span>{{ m.updated_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </button>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-emoji-smile d-block fs-2 mb-2"></i>
                            ì²« ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-9 d-flex flex-column p-0">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                        <input type="hidden" id="memo-id">
                        <input type="text" id="memo-title" class="form-control form-control-lg border-0 fw-bold"
                               placeholder="ë©”ëª¨ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="box-shadow: none;">

                        <div class="d-flex gap-2">
                            <button id="delete-btn" class="btn btn-outline-danger btn-sm px-3 rounded-pill"
                                    style="display:none;" onclick="deleteMemo()">ì‚­ì œ</button>
                            <button class="btn btn-info text-white px-4 rounded-pill fw-bold" onclick="saveMemo()">ì €ì¥</button>
                        </div>
                    </div>

                    <textarea id="memo-content" class="form-control border-0 p-4 flex-grow-1"
                              placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="resize: none; box-shadow: none; font-size: 1.1rem;"></textarea>

                    <div id="status-bar" class="p-2 px-3 bg-light border-top text-end small text-muted">
                        ì¤€ë¹„ë¨
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // 1. ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadMemo(id, title, content) {
        document.getElementById('memo-id').value = id;
        document.getElementById('memo-title').value = title;
        document.getElementById('memo-content').value = content;
        document.getElementById('delete-btn').style.display = 'block';
        document.getElementById('status-bar').innerText = "ë©”ëª¨ë¥¼ í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤.";

        // ëª©ë¡ì—ì„œ ì„ íƒëœ ëŠë‚Œ ì£¼ê¸° (Bootstrap í´ë˜ìŠ¤ í™œìš© ê°€ëŠ¥)
        document.getElementById('memo-title').focus();
    }

    // 2. ìƒˆ ë©”ëª¨ ìƒíƒœë¡œ ì´ˆê¸°í™”
    function initNewMemo() {
        document.getElementById('memo-id').value = '';
        document.getElementById('memo-title').value = '';
        document.getElementById('memo-content').value = '';
        document.getElementById('delete-btn').style.display = 'none';
        document.getElementById('status-bar').innerText = "ìƒˆ ë©”ëª¨ ì‘ì„± ëª¨ë“œ";
        document.getElementById('memo-title').focus();
    }

    // 3. ì €ì¥ (ì‹ ê·œ ìƒì„± & ìˆ˜ì • í†µí•©)
    function saveMemo() {
        const id = document.getElementById('memo-id').value;
        const title = document.getElementById('memo-title').value;
        const content = document.getElementById('memo-content').value;

        if(!content.trim()) {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch('/memo/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, title: title, content: content })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                location.reload(); // ì„±ê³µ ì‹œ ëª©ë¡ ê°±ì‹ 
            } else {
                alert(data.message || "ì €ì¥ ì‹¤íŒ¨");
            }
        })
        .catch(err => console.error("Error:", err));
    }

    // 4. ì‚­ì œ
    function deleteMemo() {
        const id = document.getElementById('memo-id').value;
        if(!id || !confirm("ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/memo/delete/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                location.reload();
            }
        });
    }

    // 5. ë©”ëª¨ ê³ ì •
    function togglePin(event, id) {
    event.stopPropagation(); // ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° ì´ë²¤íŠ¸ ë°©ì§€

    fetch(`/memo/pin/${id}`, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            location.reload(); // ê³ ì •ë˜ë©´ ìˆœì„œê°€ ë°”ë€Œì–´ì•¼ í•˜ë‹ˆ ìƒˆë¡œê³ ì¹¨!
        }
    });
}
</script>

<style>
    /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (ì„ íƒì‚¬í•­) */
    #memo-list::-webkit-scrollbar { width: 5px; }
    #memo-list::-webkit-scrollbar-thumb { background: #dee2e6; border-radius: 10px; }
    /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ í˜¸ë²„ íš¨ê³¼ */
    .list-group-item-action:hover { background-color: #f8f9fa; }
</style>
{% endblock %}