{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <div class="row shadow-sm rounded border overflow-hidden" style="height: 80vh; background-color: #fff;">

                <div class="col-md-3 border-end p-0 bg-light">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white">
                        <h6 class="fw-bold mb-0"><i class="bi bi-sticky-fill text-info"></i> 내 메모</h6>
                        <button class="btn btn-sm btn-info text-white rounded-pill px-3" onclick="initNewMemo()">
                            <i class="bi bi-plus-lg"></i> 신규
                        </button>
                    </div>

                    <div class="list-group list-group-flush overflow-auto" id="memo-list" style="max-height: calc(80vh - 60px);">
                        {% for m in memos %}
                        <button class="list-group-item list-group-item-action py-3 border-bottom"
                                onclick="loadMemo({{ m.id }}, `{{ m.title }}`, `{{ m.content }}`)">
                            <div class="fw-bold text-truncate mb-1">{{ m.title }}</div>
                            <div class="small text-muted d-flex justify-content-between">
                                <span>#{{ loop.index }}</span>
                                <span>{{ m.updated_at.strftime('%Y-%m-%d') }}</span>
                            </div>
                        </button>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-emoji-smile d-block fs-2 mb-2"></i>
                            첫 메모를 작성해보세요!
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="col-md-9 d-flex flex-column p-0">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                        <input type="hidden" id="memo-id">
                        <input type="text" id="memo-title" class="form-control form-control-lg border-0 fw-bold"
                               placeholder="메모 제목을 입력하세요" style="box-shadow: none;">

                        <div class="d-flex gap-2">
                            <button id="delete-btn" class="btn btn-outline-danger btn-sm px-3 rounded-pill"
                                    style="display:none;" onclick="deleteMemo()">삭제</button>
                            <button class="btn btn-info text-white px-4 rounded-pill fw-bold" onclick="saveMemo()">저장</button>
                        </div>
                    </div>

                    <textarea id="memo-content" class="form-control border-0 p-4 flex-grow-1"
                              placeholder="내용을 입력하세요..." style="resize: none; box-shadow: none; font-size: 1.1rem;"></textarea>

                    <div id="status-bar" class="p-2 px-3 bg-light border-top text-end small text-muted">
                        준비됨
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // 1. 메모 불러오기
    function loadMemo(id, title, content) {
        document.getElementById('memo-id').value = id;
        document.getElementById('memo-title').value = title;
        document.getElementById('memo-content').value = content;
        document.getElementById('delete-btn').style.display = 'block';
        document.getElementById('status-bar').innerText = "메모를 편집 중입니다.";

        // 목록에서 선택된 느낌 주기 (Bootstrap 클래스 활용 가능)
        document.getElementById('memo-title').focus();
    }

    // 2. 새 메모 상태로 초기화
    function initNewMemo() {
        document.getElementById('memo-id').value = '';
        document.getElementById('memo-title').value = '';
        document.getElementById('memo-content').value = '';
        document.getElementById('delete-btn').style.display = 'none';
        document.getElementById('status-bar').innerText = "새 메모 작성 모드";
        document.getElementById('memo-title').focus();
    }

    // 3. 저장 (신규 생성 & 수정 통합)
    function saveMemo() {
        const id = document.getElementById('memo-id').value;
        const title = document.getElementById('memo-title').value;
        const content = document.getElementById('memo-content').value;

        if(!content.trim()) {
            alert("내용을 입력해주세요.");
            return;
        }

        fetch('/memo/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, title: title, content: content })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                location.reload(); // 성공 시 목록 갱신
            } else {
                alert(data.message || "저장 실패");
            }
        })
        .catch(err => console.error("Error:", err));
    }

    // 4. 삭제
    function deleteMemo() {
        const id = document.getElementById('memo-id').value;
        if(!id || !confirm("이 메모를 삭제하시겠습니까?")) return;

        fetch(`/memo/delete/${id}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                location.reload();
            }
        });
    }
</script>

<style>
    /* 스크롤바 디자인 (선택사항) */
    #memo-list::-webkit-scrollbar { width: 5px; }
    #memo-list::-webkit-scrollbar-thumb { background: #dee2e6; border-radius: 10px; }
    /* 리스트 아이템 호버 효과 */
    .list-group-item-action:hover { background-color: #f8f9fa; }
</style>
{% endblock %}